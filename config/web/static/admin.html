<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Beetroot Admin</title>
  <style>
    body {
      font-family: monospace, monospace;
      background: #1e1e1e;
      color: #e0e0e0;
      padding: 2em;
      margin: 0;
    }

    h1, h2 {
      color: #ffa500;
      border-bottom: 1px solid #444;
      padding-bottom: 0.25em;
      margin-top: 0;
    }

    .status-box {
      background: #2a2a2a;
      border: 1px solid #444;
      padding: 1em;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(255, 165, 0, 0.3);
      max-width: 800px;
      margin-bottom: 2em;
    }

    .label {
      color: #ffa500;
      font-weight: bold;
    }

    pre {
      background: #111;
      color: #cfcfcf;
      padding: 0.5em;
      border-radius: 4px;
      font-size: 0.9em;
      overflow-x: auto;
      border: 1px solid #333;
    }

    a {
      color: #ffa500;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #footer {
      font-size: 0.8em;
      color: #555;
      margin-top: 3em;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="status-box">
    <h1>Beetroot Admin</h1>
    <p><span class="label">Status:</span> <span id="status">Loading...</span></p>
  </div>

  <div class="status-box">
    <h2>Version Info</h2>
    <p><span class="label">Version:</span> <span id="version">Loading...</span></p>
    <p><span class="label">Commit Hash:</span> <span id="hash">Loading...</span></p>
    <p><span class="label">Operating System:</span> <span id="os">Loading...</span></p>
    <div>
      <span class="label">Dependencies:</span>
      <pre id="dependencies">Loading...</pre>
    </div>
  </div>

<div class="status-box">
  <h2>Mose Control</h2>

  <form id="mose-form">
    <label for="mose-action" class="label">Action:</label>
    <select id="mose-action">
      <option value="ps">ps</option>
      <option value="up">up</option>
      <option value="down">down</option>
      <option value="restart">restart</option>
      <option value="pull">pull</option>
      <option value="upgrade">upgrade</option>
      <option value="import">import</option>
    </select>
    &nbsp;
    <label for="mose-project" class="label">Project (optional):</label>
    <input type="text" id="mose-project" placeholder="e.g. traefik" />
    &nbsp;
    <label>
      <input type="checkbox" id="mose-pretty" checked />
      Pretty output
    </label>
    <br><br>
    <button type="submit">Run</button>
  </form>

  <div>
    <span class="label">Output:</span>
    <pre id="mose-output">No command run yet</pre>
  </div>
</div>

<script>
  document.getElementById('mose-form').addEventListener('submit', function (e) {
    e.preventDefault();

    const action = document.getElementById('mose-action').value;
    const project = document.getElementById('mose-project').value;
    const pretty = document.getElementById('mose-pretty').checked;

    if (action === 'ps') {
      // GET to info endpoint
      let url = `/api/info/mose/ps`;
      if (project) url += `?project=${encodeURIComponent(project)}`;
      if (pretty && project) url += `&pretty=true`;
      else if (pretty) url += `?pretty=true`;

      fetch(url)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('mose-output').textContent = data.output;
          } else {
            document.getElementById('mose-output').textContent = "Error: " + data.error + "\n" + (data.output || "");
          }
        })
        .catch(err => {
          document.getElementById('mose-output').textContent = "Fetch error: " + err;
        });

    } else {
      // POST to action endpoint
      fetch(`/api/action/mose/${action}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ project, pretty })
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById('mose-output').textContent = data.output;
          } else {
            document.getElementById('mose-output').textContent = "Error: " + data.error + "\n" + (data.output || "");
          }
        })
        .catch(err => {
          document.getElementById('mose-output').textContent = "Fetch error: " + err;
        });
    }
  });
</script>

  <div id="footer">Beetroot Admin UI &mdash; updated <script>document.write(new Date().toLocaleString())</script></div>

  <script>
    function fetchStatus() {
      fetch('/api/health')
        .then(res => res.json())
        .then(data => {
          document.getElementById('status').textContent = data.status;
        })
        .catch(err => {
          document.getElementById('status').textContent = "Error";
          console.error(err);
        });
    }

    function fetchVersionInfo() {
      fetch('/api/version')
        .then(res => res.json())
        .then(data => {
          document.getElementById('version').textContent = data.version || 'unknown';
          document.getElementById('hash').textContent = data.hash || 'unknown';
          document.getElementById('os').textContent = data.os || 'unknown';

          const deps = data.dependencies || {};
          const formatted = Object.keys(deps)
            .map(k => `${k}: ${deps[k]}`)
            .join('\n');
          document.getElementById('dependencies').textContent = formatted || 'none';
        })
        .catch(err => {
          document.getElementById('version').textContent = "Error";
          document.getElementById('hash').textContent = "Error";
          document.getElementById('os').textContent = "Error";
          document.getElementById('dependencies').textContent = "Error loading dependencies";
          console.error(err);
        });
    }

    function refreshAll() {
      fetchStatus();
      fetchVersionInfo();
    }

    refreshAll();
    setInterval(refreshAll, 30000);
  </script>
</body>
</html>
